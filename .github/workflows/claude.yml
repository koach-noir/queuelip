name: Claude Code

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  issues:
    types: [opened, assigned]
  pull_request_review:
    types: [submitted]
  pull_request:
    types: [opened, synchronize]

jobs:
  claude:
    # @claude コメントでトリガー
    if: |
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review' && contains(github.event.review.body, '@claude')) ||
      (github.event_name == 'issues' && (contains(github.event.issue.body, '@claude') || contains(github.event.issue.title, '@claude')))
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Run Claude Code Action (GitHub Integration)
        uses: anthropics/claude-code-action@beta
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}

  # Pull Request 自動レビュー
  auto-review:
    if: github.event_name == 'pull_request' && (github.event.action == 'opened' || github.event.action == 'synchronize')
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Claude Code Review
        uses: anthropics/claude-code-base-action@beta
        with:
          prompt: |
            Review this pull request thoroughly:
            1. Code quality and JavaScript/Tauri best practices
            2. Potential bugs or security issues  
            3. Performance considerations
            4. Test coverage and documentation
            5. Adherence to project standards
            
            Provide constructive feedback with specific suggestions for improvement.
            Focus on maintainability and security.
          allowed_tools: "Bash(git:*),View,GlobTool,GrepTool,BatchTool"
          max_turns: "5"
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}

  # 高度な機能実装
  claude-implement:
    if: |
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '/claude-implement')) ||
      (github.event_name == 'issues' && contains(github.event.issue.body, '/claude-implement'))
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Implement Feature with Claude
        uses: anthropics/claude-code-base-action@beta
        with:
          prompt: |
            Based on the issue description, implement the requested feature comprehensively:
            1. Analyze the existing codebase structure
            2. Implement the feature following project patterns (JavaScript/Tauri)
            3. Create or update tests as needed
            4. Update documentation if required
            5. Ensure backward compatibility
            
            Focus on creating production-ready, maintainable code.
          allowed_tools: "Bash(git:*),View,GlobTool,GrepTool,BatchTool,mcp__github__create_pull_request"
          max_turns: "15"
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}